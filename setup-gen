#!/bin/bash

SCM_NAME=""
SCM_EMAIL="$(whoami)@$(hostname --short)"

gen_gitconfig() {
  cat <<EOF
# Autogenerated by ~/.dotfiles/setup-gen

[user]
        ${SCM_NAME:+name = ${SCM_NAME}
}email = ${SCM_EMAIL}

[color]
        ui = auto

[alias]
        br = branch
        st = status
        ci = commit
        cia = commit --amend
        co = checkout
        cp = cherry-pick
        lg = log --pretty=oneline --abbrev-commit --decorate
        cw = commit -m wip
        w = commit -a -m wip

        amend = commit --amend
        detach = !git checkout HEAD^0
        unstage = reset HEAD --

        # Aggressive git, add --aggressive for more effect
        gca = !git -c gc.reflogExpire=0 -c gc.reflogExpireUnreachable=0 \\
                -c gc.rerereresolved=0 -c gc.rerereunresolved=0 \\
                -c gc.pruneExpire=now gc --prune=now

        # Creates an empty branch with no history.
        make-empty-branch = !git commit-tree -m "\${1:-empty}" \$(git mktree </dev/null) >"\$GIT_DIR/refs/heads/\${1:-empty}"

[push]
        default = matching
EOF
}

gen_hgrc() {
  cat <<EOF
# Autogenerated by ~/.dotfiles/setup-gen
[ui]
username = ${SCM_NAME}${SCM_NAME:+ }<${SCM_EMAIL}>
EOF
}

setup_gen() {
  if ! [[ -f gitconfig ]] || grep -q '^# Autogenerated' gitconfig; then
    gen_gitconfig >gitconfig.tmp
    if ! cmp --silent gitconfig gitconfig.tmp; then
      echo Generated gitconfig
      mv -f gitconfig.tmp gitconfig
    else
      rm -f gitconfig.tmp
    fi
  fi

  if ! [[ -f hgrc ]] || grep -q '^# Autogenerated' hgrc; then
    gen_hgrc >hgrc.tmp
    if ! cmp --silent hgrc hgrc.tmp; then
      echo Generated hgrc
      mv -f hgrc.tmp hgrc
    else
      rm -f hgrc.tmp
    fi
  fi
}

[[ -f ./setup-gen.local ]] && source ./setup-gen.local

if declare -f setup_gen_local >/dev/null 2>&1; then
  setup_gen_local
else
  setup_gen
fi

# vim: et
