#!/bin/bash

SCM_NAME=""
SCM_EMAIL="$(whoami)@$(hostname --short)"

gen_gitconfig() {
  cat <<EOF
# Autogenerated

[user]
        ${SCM_NAME:+name = ${SCM_NAME}
        }email = ${SCM_EMAIL}

[color]
	ui = auto

[alias]
	st = status
	co = checkout
	cp = cherry-pick
	lg = log --pretty=oneline --abbrev-commit --decorate

	amend = commit --amend
	detach = !git checkout HEAD^0
	unstage = reset HEAD --

        # Aggressive git, add --aggressive for more effect
	gca = !git -c gc.reflogExpire=0 -c gc.reflogExpireUnreachable=0 \\
		-c gc.rerereresolved=0 -c gc.rerereunresolved=0 \\
		-c gc.pruneExpire=now gc --prune=now

[push]
	default = matching
EOF
}

gen_hgrc() {
  cat <<EOF
# Autogenerated
[ui]
username = ${SCM_NAME}${SCM_NAME:+ }<${SCM_EMAIL}>
EOF
}

setup_gen() {
  if ! [[ -f gitconfig ]] || grep -q '^# Autogenerated' gitconfig; then
    echo Generating gitconfig
    gen_gitconfig >gitconfig
  fi

  if ! [[ -f hgrc ]] || grep -q '^# Autogenerated' hgrc; then
    echo Generating hgrc
    gen_hgrc >hgrc
  fi
}

[[ -x ./setup-gen.local ]] && source ./setup-gen.local

if declare -f setup_gen_local >/dev/null 2>&1; then
  setup_gen_local
else
  setup_gen
fi
